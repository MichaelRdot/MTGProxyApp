@page "/"
@using MTGProxyApp.Dtos
@using MTGProxyApp.Models
@using MTGProxyApp.Services
@inject ScryfallService Scryfall

<h2>MTG Proxy Builder</h2>

<div class="mb-3">
  <button class="btn btn-primary" @onclick="PromptAndSave">Save Deck Images</button>
</div>

<textarea class="form-control" rows="8" @bind="DeckText" placeholder="Paste lines like:
1 Nissa, Worldsoul Speaker (DRC) 13
1 Nissa, Worldsoul Speaker"></textarea>

<div class="mt-2">
  <button class="btn btn-success" @onclick="ParseAndLoad">Parse & Load</button>
</div>

@if (Errors.Count > 0)
{
  <div class="alert alert-warning mt-3">
    <ul>
      @foreach (var e in Errors) { <li>@e</li> }
    </ul>
  </div>
}

@if (Cards.Count > 0)
{
  <div class="row row-cols-1 row-cols-md-3 g-3 mt-3">
    @foreach (var c in Cards)
    {
      <div class="col">
        <div class="card h-100">
          @if (c.PngUri is not null)
          {
            <img src="@c.PngUri" class="card-img-top" style="cursor:pointer"
                 @onclick="@(() => OpenArtPicker(c))" />
          }
          else
          {
            <div class="p-3 text-muted">No image found</div>
          }
          <div class="card-body">
            <h5 class="card-title">@c.DisplayName</h5>
            <button class="btn btn-outline-secondary" @onclick="@(() => OpenArtPicker(c))">
              Choose Alternate Art
            </button>
          </div>
        </div>
      </div>
    }
  </div>

  <div class="my-4">
    <button class="btn btn-primary" @onclick="PromptAndSave">Save Deck Images</button>
  </div>
}

<!-- Art Picker Modal -->
@if (ShowPicker)
{
  <div class="modal-backdrop fade show"></div>
  <div class="modal d-block" tabindex="-1" style="background:rgba(0,0,0,0.4)">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Choose Art — @Current?.DisplayName</h5>
          <button type="button" class="btn-close" @onclick="ClosePicker"></button>
        </div>
        <div class="modal-body">
          @if (PickerLoading)
          {
            <div>Loading art…</div>
          }
          else if (PickerOptions.Count == 0)
          {
            <div>No alternate art found.</div>
          }
          else
          {
            <div class="container-fluid">
              <div class="row row-cols-1 row-cols-md-3 g-3">
                @foreach (var opt in PickerOptions)
                {
                  <div class="col">
                    <img src="@opt" class="img-fluid" style="cursor:pointer"
                         @onclick="@(() => ChooseArt(opt))" />
                  </div>
                }
              </div>
            </div>
          }
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" @onclick="ClosePicker">Close</button>
        </div>
      </div>
    </div>
  </div>
}

@code {
  private string DeckText = "";
  private List<string> Errors = new();
  private List<ChosenCardModel> Cards = new();

  private bool ShowPicker = false;
  private bool PickerLoading = false;
  private ChosenCardModel? Current;
  private List<Uri> PickerOptions = new();

  private async Task ParseAndLoad()
  {
    Errors.Clear();
    Cards.Clear();

    var lines = DeckText.Split('\n', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);

    foreach (var line in lines)
    {
      if (!DeckLineModel.TryParse(line, out var dl) || dl is null)
      {
        Errors.Add($"Could not parse: \"{line}\"");
        continue;
      }

      // Prefer exact set+collector when provided; otherwise named fuzzy
      CardDto? card;
      if (!string.IsNullOrWhiteSpace(dl.SetCode) && !string.IsNullOrWhiteSpace(dl.CollectorNumber))
      {
        card = await Scryfall.GetCardBySetAndCollector(dl.SetCode!, dl.CollectorNumber!);
      }
      else
      {
        card = await Scryfall.GetCardByName("fuzzy", dl.Name);
      }

      if (card is null)
      {
        Errors.Add($"Scryfall lookup failed for: \"{dl.Name}\"");
        continue;
      }

      var png = card.ImageUris?.Png
                ?? card.CardFaces?.FirstOrDefault()?.ImageUris?.Png;

      if (png is null)
      {
        Errors.Add($"No PNG found for: \"{dl.Name}\"");
        continue;
      }

      Cards.Add(new ChosenCardModel {
        Source = dl,
        PngUri = png,
        PrintsSearchUri = card.PrintsSearchUri
      });
    }
  }

  private async Task OpenArtPicker(ChosenCardModel c)
  {
    ShowPicker = true;
    PickerLoading = true;
    Current = c;
    PickerOptions.Clear();

    try
    {
      var prints = await Scryfall.GetPrintsAsync(c.PrintsSearchUri);
      // Each printing may be single-face or double-face
      foreach (var pr in prints)
      {
        var png = pr.ImageUris?.Png ?? pr.CardFaces?.FirstOrDefault()?.ImageUris?.Png;
        if (png is not null) PickerOptions.Add(png);
      }
    }
    finally
    {
      PickerLoading = false;
      StateHasChanged();
    }
  }

  private void ClosePicker()
  {
    ShowPicker = false;
    Current = null;
    PickerOptions.Clear();
  }

  private void ChooseArt(Uri uri)
  {
    if (Current is not null)
    {
      Current.PngUri = uri;
    }
    ClosePicker();
  }

  private async Task PromptAndSave()
  {
    var deckName = await JSPrompt("Enter deck name:");
    if (string.IsNullOrWhiteSpace(deckName)) return;

    var urls = Cards
      .SelectMany(c => Enumerable.Repeat(c.PngUri?.ToString() ?? "", c.Source.Count))
      .Where(s => !string.IsNullOrWhiteSpace(s))
      .ToList();

    if (urls.Count == 0) return;

    using var http = new HttpClient();
    var payload = new SaveDeckRequest { DeckName = deckName.Trim(), ImageUrls = urls };
    var resp = await http.PostAsJsonAsync("/api/save-deck", payload);
    if (resp.IsSuccessStatusCode)
    {
      // Server returns a zip; trigger download
      var blob = await resp.Content.ReadAsByteArrayAsync();
      var base64 = Convert.ToBase64String(blob);
      await JSTriggerDownload($"{deckName}.zip", base64);
    }
  }

  // JS interop helpers
  [Inject] IJSRuntime JS { get; set; } = default!;

  private async Task<string?> JSPrompt(string message) =>
      await JS.InvokeAsync<string?>("prompt", message);

  private async Task JSTriggerDownload(string filename, string base64Data) =>
      await JS.InvokeVoidAsync("downloadFileFromBytes", filename, base64Data);

  private class SaveDeckRequest
  {
    public string DeckName { get; set; } = "";
    public List<string> ImageUrls { get; set; } = new();
  }
}