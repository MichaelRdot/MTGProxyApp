@using MTGProxyApp.Dtos
@using MTGProxyApp.Services
@inject IDialogService DialogService
@inject HttpService HttpService

@if (!_loading)
{
    <MudDialog>
        <DialogContent>
            <MudText>Select your chosen card art.</MudText>
            <MudGrid Spacing="4" Justify="Justify.FlexStart">
                @foreach (var card in _cardList)
                {
                    <MudItem xs="12" sm="6" md="4" lg="3" xl="2" xxl="1">
                        <MudCard Outlined="true">
                            <MudCardContent>
                                <MudButton @onclick="@(() => SelectArt(card))">
                                    <MudImage Src="@GetImageUrl(card)" Fluid/>
                                </MudButton>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                }
            </MudGrid>
        </DialogContent>
        <DialogActions>
            <MudButton OnClick="Close">Close</MudButton>
        </DialogActions>
    </MudDialog>
}

@code {
    [CascadingParameter] private IMudDialogInstance? MudDialog { get; set; } = default!;
    [Parameter] public required CardDto Card { get; set; }
    
    private List<CardDto> _cardList = new();
    private PaginatedListDto<CardDto>? _paginatedCardList;
    private bool _loading = true;

    private void Close() => MudDialog.Cancel();

    private void SelectArt(CardDto card) => MudDialog.Close(DialogResult.Ok(card));

    private string GetImageUrl(CardDto card) => card.ImageUris?.Png?.ToString() ?? card.CardFaces?.FirstOrDefault()?.ImageUris?.Png?.ToString() ?? "images/card-placeholder.png";

    protected override async Task OnInitializedAsync()
    {
        _paginatedCardList = await HttpService.GetResponse<PaginatedListDto<CardDto>>(Card.PrintsSearchUri);
        _cardList = _paginatedCardList.Data;
        
        await base.OnInitializedAsync();
        _loading = false;
    }
}