@page "/"
@using System.Text
@using System.Text.RegularExpressions
@using MTGProxyApp.Dtos
@using MTGProxyApp.Models
@using MTGProxyApp.Services
@rendermode InteractiveServer

@inject ScryfallService ScryfallService
@inject ISnackbar Snackbar

<MudContainer>
    <MudTextField @bind-Value="_deckTextField" Variant="Variant.Outlined" Lines="10" Label="@_label"
                  HelperText="@_helperText" Placeholder="@_placeholderText"/>
    <MudButton Variant="Variant.Filled" Color="Color.Dark" OnClick="@Load">Load</MudButton>
    <MudButton Variant="Variant.Filled" Color="Color.Dark" OnClick="@Download">Download</MudButton>
    <MudButton Variant="Variant.Filled" Color="Color.Dark" StartIcon="@_icon" OnClick="@BlackCornersToggle">BlackCorners</MudButton>
    <MudButton Variant="Variant.Filled" Color="Color.Dark" StartIcon="@_icon" OnClick="@CutLinesToggle">Cut Lines</MudButton>
    <MudDivider/>
</MudContainer>
<MudGrid Spacing="4" Justify="Justify.FlexStart">
    @foreach(var card in _cards)
    {
        <MudCardCard Card="@card"
                     UpdatedCard="OnCardUpdated"/>
    }
</MudGrid>

@code{
    string _deckTextField = "";
    readonly string _label = "Deck Text";
    readonly string _helperText = "This is where you put your deck :)";
    readonly string _placeholderText = "1 Sol ring (C21) 263\n5 sol ring\nsol ring (C21)\nsol ring";

    readonly string _icon = Icons.Material.Filled.CheckBoxOutlineBlank;

    List<string> _currentCardList = new();
    List<CardDto?> _cards = new();

    void OnCardUpdated(CardDto card)
    {
        var newLine = UpdateDeckList(card);
        _currentCardList = _deckTextField
            .Split(Environment.NewLine, StringSplitOptions.RemoveEmptyEntries)
            .ToList();
        _currentCardList[card.LineIndex] = newLine;
        var tempDeckText = new StringBuilder();
        foreach (var cardLine in _currentCardList) tempDeckText.Append(cardLine + "\n");
        _deckTextField = tempDeckText.ToString();
    }

    async Task Load()
    {
        var tempDeckText = new StringBuilder();
        _cards.Clear();
        _currentCardList = _deckTextField
            .Split("\n", StringSplitOptions.RemoveEmptyEntries)
            .ToList();
        foreach (var cardLine in _currentCardList)
        {
            if (!DeckLineModel.TryParse(cardLine, out var cardModel))
            {
                Snackbar.Add($"Had an issue parsing line: {cardLine}", Severity.Error);
            }
            else
            {
                var queryStringBuilder = new StringBuilder();

                queryStringBuilder.Append($"!\"{cardModel.Name}\"");
                if (cardModel.SetCode != null) queryStringBuilder.Append($" set:{cardModel.SetCode}");
                if (cardModel.CollectorNumber != null) queryStringBuilder.Append($" cn:{cardModel.CollectorNumber}");

                try
                {
                    var cardList = await ScryfallService.GetCardsBySearchQuery(queryStringBuilder.ToString());
                    if (cardList?.Data[0] == null) throw new Exception("Cards not found");
                    var card = cardList.Data[0];

                    card.Count = cardModel.Count;
                    card.LineIndex = _currentCardList.IndexOf(cardLine);

                    _cards.Add(cardList.Data[0]);
                    tempDeckText.Append(UpdateDeckList(card) + "\n");
                    Snackbar.Add($"Successfully added card: {cardModel.Name}", Severity.Success);
                }
                catch (Exception e)
                {
                    Snackbar.Add($"{e.Message} for line: {cardLine}", Severity.Error);
                }
            }
        }
        _deckTextField = tempDeckText.ToString();
    }

    string UpdateDeckList(CardDto card) => $"{card.Count} {card.Name} ({card.Set.ToUpperInvariant()}) {card.CollectorNumber}"; 

    void Download()
    {
    }

    void BlackCornersToggle()
    {
    }

    void CutLinesToggle()
    {
    }
    
}